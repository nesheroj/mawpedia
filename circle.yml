machine:
  services:
    - docker

dependencies:
  override:
    - docker info
    - docker build -t mawpedia .
    - mkdir node_modules

test:
  override:
    - docker run --name mawpedia mawpedia npm run circle
    - rm -r ./node_modules
    - docker cp mawpedia:/usr/src/app/node_modules .
    - docker cp mawpedia:/usr/src/app/coverage.lcov $CIRCLE_TEST_REPORTS/
    - docker cp mawpedia:/usr/src/app/.nyc_output $CIRCLE_TEST_REPORTS/

deployment:
  digitalocean:
    branch: master
    owner: nesukun
    commands:
      - docker save -o $CIRCLE_ARTIFACTS/mawpedia.tar mawpedia
      - scp -C $CIRCLE_ARTIFACTS/mawpedia.tar root@purpletentacle.rocks:~/mawpedia/mawpedia.tar
      - scp -C docker-compose* root@purpletentacle.rocks:~/mawpedia/
      - 'ssh root@purpletentacle.rocks "docker load -i ~/mawpedia/mawpedia.tar"'
      - 'ssh root@purpletentacle.rocks "docker-compose -f ~/mawpedia/docker-compose.production.yml down && docker-compose -f ~/mawpedia/docker-compose.production.yml up -d"'
